pipeline {
    agent any

    environment {
        FRONTEND_IMAGE = "my-frontend-app"
        BACKEND_IMAGE = "my-backend-app"
        NETWORK_NAME = "app-network"
    }

    stages {

        stage('Clone Repo') {
            steps {
                git 'https://github.com/Sanjuraghava/react-app.git'
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    sh 'docker build -t $FRONTEND_IMAGE ./frontend'
                    sh 'docker build -t $BACKEND_IMAGE ./backend'
                }
            }
        }

        stage('Create Docker Network') {
            steps {
                script {
                    sh 'docker network create $NETWORK_NAME || true'
                }
            }
        }

        stage('Run Containers') {
            steps {
                script {
                    sh '''
                    docker run -d --rm --name backend --network $NETWORK_NAME $BACKEND_IMAGE
                    docker run -d --rm --name frontend --network $NETWORK_NAME -p 3000:3000 $FRONTEND_IMAGE
                    '''
                }
            }
        }

        stage('Wait & Test') {
            steps {
                echo 'Waiting for containers to be ready...'
                sh 'sleep 10'
                sh 'curl -I http://localhost:3000 || true'
            }
        }
    }

    post {
        always {
            echo 'Cleaning up containers...'
            sh '''
            docker rm -f frontend || true
            docker rm -f backend || true
            docker network rm $NETWORK_NAME || true
            '''
        }
    }
}
